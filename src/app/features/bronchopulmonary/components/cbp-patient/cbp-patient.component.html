<div class="container">
    <h2>Sección Cáncer Broncopulmonar</h2>
    <mat-accordion class="headers-align" multi>
        <!-- Screening survey panel -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    Encuesta Inicial
                </mat-panel-title>
                <mat-panel-description>
                    Contiene los datos obtenidos a través de la encuesta inicial.
                    <mat-icon *ngIf="surveyForm.pristine; else saveSurvey">fact_check</mat-icon>
                    <ng-template #saveSurvey>
                        <button type="button" *appPermission="[PERMISSIONS.ADMIN]; feature FEATURES.PATIENT_FILES" mat-raised-button color="primary" (click)="updateEnrollmentSurvey()">Guardar Encuesta</button>
                    </ng-template>
                </mat-panel-description>
            </mat-expansion-panel-header>
            <section [formGroup]="surveyForm">
                <h4>Marque los campos que apliquen:</h4>
                <p *ngFor="let question of survey">
                    <mat-checkbox *ngIf="question.type=='boolean'" formControlName="{{question.name}}">
                        {{question.msg}}</mat-checkbox>
                </p>
            </section>
        </mat-expansion-panel>
        <!-- Current status info panel -->
        <mat-expansion-panel [formGroup]="patientForm">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    Información de Estado
                </mat-panel-title>
                <mat-panel-description>
                    Contiene el estado del paciente dentro de la sección broncopulmonar.
                    <mat-icon *ngIf="patientForm.pristine; else savePatient">person_outline</mat-icon>
                    <ng-template #savePatient>
                        <button type="button" *appPermission="[PERMISSIONS.ADMIN]; feature FEATURES.PATIENT_FILES" mat-raised-button color="primary" (click)="updatePatientState()">Guardar Cambios</button>
                    </ng-template>
                </mat-panel-description>
            </mat-expansion-panel-header>
            <section>
                <mat-form-field appearance="fill">
                    <mat-label>Estado</mat-label>
                    <mat-select formControlName="state">
                        <mat-option value="Activo">Activo</mat-option>
                        <mat-option value="Inactivo">Inactivo</mat-option>
                        <mat-option value="Derivado">Derivado</mat-option>
                        <mat-option value="Rechazado">Rechazado</mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Derivación</mat-label>
                    <mat-select formControlName="derivationStateNfm">
                        <mat-option value="Rechaza">Rechaza</mat-option>
                        <mat-option value="En curso">En curso</mat-option>
                        <mat-option value="Terminado">Terminado</mat-option>
                        <mat-option value="Abandono">Abandono</mat-option>
                    </mat-select>
                </mat-form-field>
            </section>
            <section>
                <mat-form-field appearance="fill">
                    <mat-label>Fecha de Detección Cancer</mat-label>
                    <input matInput [matDatepicker]="cancerPicker" formControlName="cancerDetectionDate">
                    <mat-datepicker-toggle matSuffix [for]="cancerPicker"></mat-datepicker-toggle>
                    <mat-datepicker #cancerPicker></mat-datepicker>
                </mat-form-field>
            </section>
        </mat-expansion-panel>
        <mat-expansion-panel (opened)="loadExams()">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    Exámenes
                </mat-panel-title>
                <mat-panel-description>
                    Listado de TAC y Biopsias del paciente
                    <mat-icon>fact_check</mat-icon>
                </mat-panel-description>
            </mat-expansion-panel-header>
            <h4>Exámenes TAC</h4><br>
            <div *appPermission="[PERMISSIONS.ADMIN]; feature FEATURES.EXAMS" [formGroup]="tacForm">
                <p>Nuevo Tac</p>
                <section>
                    <mat-divider></mat-divider>
                    <mat-form-field appearance="fill">
                        <mat-label>Tipo</mat-label>
                        <mat-select formControlName="nodule">
                            <mat-option value="Vidrioesmerilado">Vidrioesmerilado</mat-option>
                            <mat-option value="Mixto ">Mixto </mat-option>
                            <mat-option value="Solido">Solido</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="fill">
                        <mat-label>Tamaño</mat-label>
                        <input matInput type="number" formControlName="size">
                    </mat-form-field>
                    <mat-form-field appearance="fill">
                        <mat-label>LUNG/RAD</mat-label>
                        <mat-select formControlName="lungRads">
                            <mat-option value="0">0</mat-option>
                            <mat-option value="1">1</mat-option>
                            <mat-option value="2">2</mat-option>
                            <mat-option value="3">3</mat-option>
                            <mat-option value="4A">4A</mat-option>
                            <mat-option value="4B">4B</mat-option>
                            <mat-option value="4S">4S</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="fill">
                        <mat-label>Fecha exámen</mat-label>
                        <input matInput [matDatepicker]="tacPicker" formControlName="ldctDate">
                        <mat-datepicker-toggle matSuffix [for]="tacPicker"></mat-datepicker-toggle>
                        <mat-datepicker #tacPicker></mat-datepicker>
                    </mat-form-field>
                    <button mat-raised-button color="primary" (click)="addTac()">Agregar</button>
                </section>
                <span *ngIf="tacForm.get('lungRads')?tacForm.get('lungRads')?.value?.includes('4'):false">
                    <p [class.error-text]="tacForm.hasError('actionRequired') && isTouched">Indique la acción a realizar:</p>
                    <p><mat-checkbox formControlName="petTc">PET/TL</mat-checkbox></p>
                    <p><mat-checkbox *ngIf ="tacForm.get('lungRads')?.value !== '4A'" formControlName="biopsy">Biopsia</mat-checkbox></p>
                    <mat-form-field appearance="fill">
                        <mat-label>Agendar TAC en:</mat-label>
                        <input matInput type="number" placeholder="días" formControlName="proposedTime">
                    </mat-form-field>
                </span>
            </div>
            <div class="mat-elevation-z8">
                <table mat-table [dataSource]="tacList" matSort>
                    <!-- ID Column -->
                    <ng-container matColumnDef="idLdct">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                        <td mat-cell *matCellDef="let row"> {{row.idLdct}} </td>
                    </ng-container>

                    <!-- Size -->
                    <ng-container matColumnDef="size">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tamaño </th>
                        <td mat-cell *matCellDef="let row"> {{row.size}} </td>
                    </ng-container>

                    <!-- NODULE -->
                    <ng-container matColumnDef="nodule">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Nódulo </th>
                        <td mat-cell *matCellDef="let row"> {{row.nodule}} </td>
                    </ng-container>

                    <!-- LUNG RAD -->
                    <ng-container matColumnDef="lungRads">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> LUNG/RAD </th>
                        <td mat-cell *matCellDef="let row"> {{row.lungRads}} </td>
                    </ng-container>
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Acciones</th>
                        <td mat-cell *matCellDef="let row"> {{(row.petTc?"PET/TC ":'')+(row.biopsy?"Biopsia ":'')+(row.nextDate?"TAC":'')}} </td>
                    </ng-container>
                    <!-- Delete Column -->
                    <ng-container matColumnDef="delete">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Eliminar</th>
                        <td mat-cell *matCellDef="let row">
                            <button type="button" mat-icon-button color="primary" (click)="deleteTac(row)">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="tacColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: tacColumns;"></tr>

                    <!-- Row shown when there is no matching data. -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell" colspan="4">{{ NO_TABLE_DATA }}</td>
                    </tr>
                </table>
                <mat-paginator [pageSizeOptions]="pageSizeOptions" aria-label="Muestra page of TAC" #tacPaginator="matPaginator"></mat-paginator>
            </div>
            <mat-divider></mat-divider>
            <h4>Biopsias</h4>
            <section [formGroup]="biopsyForm" *appPermission="[PERMISSIONS.ADMIN]; feature FEATURES.EXAMS">
                <p>Nueva Biopsia</p>
                <mat-divider></mat-divider>
                <mat-form-field appearance="fill">
                    <mat-label>TIPO</mat-label>
                    <mat-select formControlName="type">
                        <mat-option *ngFor="let bio of bioTypes" [value]="bio.type">{{ bio.type }}</mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Fecha examen</mat-label>
                    <input matInput [matDatepicker]="bpsyPicker" formControlName="biopsyDate">
                    <mat-datepicker-toggle matSuffix [for]="bpsyPicker"></mat-datepicker-toggle>
                    <mat-datepicker #bpsyPicker></mat-datepicker>
                </mat-form-field>
                <button mat-raised-button color="primary" (click)="addBiopsy()">Agregar</button>
            </section>
            <div class="mat-elevation-z8">
                <table mat-table [dataSource]="bpsyList" matSort>
                    <!-- ID Column -->
                    <ng-container matColumnDef="idBiopsy">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                        <td mat-cell *matCellDef="let row"> {{row.idBiopsy}} </td>
                    </ng-container>

                    <!-- Progress Column -->
                    <ng-container matColumnDef="type">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tamaño </th>
                        <td mat-cell *matCellDef="let row"> {{row.type}} </td>
                    </ng-container>

                    <!-- Name Column -->
                    <ng-container matColumnDef="biopsyDate">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Nódulo </th>
                        <td mat-cell *matCellDef="let row"> {{formatDate(row.biopsyDate)}} </td>
                    </ng-container>

                    <!-- Delete Column -->
                    <ng-container matColumnDef="delete">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Eliminar</th>
                        <td mat-cell *matCellDef="let row">
                            <button type="button" mat-icon-button (click)="deleteBiopsy(row)">
                                <mat-icon color="primary">delete</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="bpsyColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: bpsyColumns;"></tr>

                    <!-- Row shown when there is no matching data. -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell" colspan="4">{{ NO_TABLE_DATA }}</td>
                    </tr>
                </table>
                <mat-paginator [pageSizeOptions]="pageSizeOptions" aria-label="Muestra page of Biopsia" #bioPaginator="matPaginator"></mat-paginator>
            </div>
        </mat-expansion-panel>

    </mat-accordion>
</div>